(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9603],{8266:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/search",function(){return s(53690)}])},53690:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return I}});var a=s(85893),r=s(67294),n=s(72206),l=s(49154),i=s(38269),o=s(56726),c=s(43503),u=s(68295),d=s(4869),h=s(39181),g=s(11163),f=s(9473),p=s(62161),x=s(84913),m=s(23330),y=s(1852),w=s(9581),j=s(86892),S=s(41478),v=s(54972);let _="search",N=()=>{let[e,t]=(0,r.useState)(!0),[s,N]=(0,r.useState)([]),{chatTitle:b,setChatTitle:C}=(0,r.useContext)(u.py),{message:E,setMessage:k}=(0,r.useContext)(u.py),[T,Z]=(0,r.useState)(null),[I,M]=(0,r.useState)({content:"",isUser:!1,loading:!1}),[O,A]=(0,r.useState)(null),[F,H]=(0,r.useState)(null),{selectedTopicInfo:q,setSelectedTopicInfo:P}=(0,r.useContext)(u.py),{currentChat:R,setCurrentChat:D}=(0,r.useContext)(u.py),[L,U]=(0,r.useState)(!1),{chatHistory:J,setChatHistory:z}=(0,r.useContext)(u.py),[G,X]=(0,r.useState)(!1),{currentTid:B,setCurrentTid:Q}=(0,r.useContext)(u.py),{setActiveChat:V,activeChat:W}=(0,r.useContext)(u.py),{loadingTid:$,setLoadingTid:K}=(0,r.useContext)(u.py),{isMessageSent:Y,setMessageSent:ee}=(0,r.useContext)(u.py),{userInfo:{globalOrgId:et}}=(0,f.v9)(e=>e),[es,ea]=(0,r.useState)(1),[er,en]=(0,r.useState)(),[el,ei]=(0,r.useState)(null),eo=(0,g.useRouter)(),ec=(0,f.I0)(),{tid:eu,isNewTopic:ed,isTidTemp:eh,altTid:eg,titleGen:ef}=q;(0,r.useEffect)(()=>{let e=localStorage.getItem("token");A(e),t(!1)},[]),(0,r.useEffect)(()=>{let e=localStorage.getItem("token");e?Z(e):eo.push("/sign-in")},[]);let ep=async e=>{try{let t=await(0,d.Rw)(e);if(t.success){let e=Array.isArray(t.data.conversations)?t.data.conversations:[],s=t.data.topic.title;D(e),C(s)}}catch(e){}},ex=(0,r.useRef)(eu);(0,r.useEffect)(()=>{if(-1!=q.altTid&&q.altTid==ex.current){ex.current=eu;return}let e=eu!=ex.current;ex.current=eu,ed&&e&&q.clearConvs&&D([]),!ed&&e&&ep(eu)},[q]),(0,r.useEffect)(()=>{U(e=>!e)},[J]),(0,r.useEffect)(()=>{},[q]);let em=async()=>{let e=await(0,d.p7)();console.log(e,"resresres"),e.success&&ei(e.data)};(0,j.Z)(()=>{try{em()}catch(e){}}),(0,r.useEffect)(()=>{if(-1!=eu&&!1===ef&&!1===eh){let e=async()=>{console.log("当 newChatFlag 变化时重新生成标题"),X(!0);try{let e=await(0,c.TZ)(eu);X(!1),z(t=>{let s=t.map(t=>t.id===eg||t.id===eu?{...t,title:e.data.title,id:eu}:t);return s}),P({...q,titleGen:!0})}catch(e){console.error("Error in generating title:",e),X(!1)}};e()}},[q]);let ey=()=>{ec((0,p.Hr)({page:_,status:"dialogue"}))},ew=e=>{if("responding"==ej)return!1;if(""!==e.trim()){let t={q:e,isUser:!0,time:new Date().toISOString()};D(e=>[...e,t]);let s={a:" ",loading:!0};D(e=>[...e,s]),k(""),ee(!0);try{ec((0,p.Hr)({page:_,status:"sending"}));let t=(0,x.Z)({url:"/api/search_conversation?org_id=".concat(et,"&req_rand=").concat(Math.random()),body:JSON.stringify({text:e,model_params:{},topic_id:"dialogue"===ej&&-1!=eu?eu:null}),onOpen(e){if(!e.success){let{detail:t,errcode:s}=e.data;D(e=>{let a=e.slice(0,e.length-1),r={a:(0,m.Pq)(s,t),loading:!1};return[...a,r]}),ey()}},onMessage:async s=>{let a;let r=s.event;switch(r){case"meta":try{if((a=JSON.parse(s.data))&&a.tid){if("new_chat"==ej){let e={id:a.tid,title:"New Chat"};z(t=>[e,...t])}q.isTidTemp&&P({...q,tid:a.tid,isTidTemp:!1,isNewTopic:!0,altTid:a.tid,titleGen:!1,clearConvs:!1}),Q(a.tid),V(a.tid)}}catch(e){console.error("Failed to parse event data:",e);return}break;case"update":try{a=JSON.parse(s.data);let t=a.cid,r={q:e,a:a.content,time:new Date().toISOString(),cid:t};D(e=>{if(e){let t=e.slice(0,e.length-1),s=[...t,{...r,loading:!1}];return s}});let n=[...R,r];D(n),ec((0,p.Hr)({page:_,status:"responding"}))}catch(e){console.error("Failed to parse event data:",e);return}break;case"err":D(e=>{let t=e.slice(0,e.length-1);return[...t,{a:"Network Anomaly",loading:!1}]}),ey(),t.abort();break;case"end":K(!0),K(!1)}},onError:e=>{D(e=>{let t=e.slice(0,e.length-1);return[...t,{a:"Network Anomaly",loading:!1}]}),ey(),t.abort()},onClose(){ec((0,S.yA)()),ea(es+1)},onFinally(){console.log("onFinally"),ey()}});en(t)}catch(e){console.log(e,"errorerror"),ey(),er&&er.abort()}}};(0,r.useEffect)(()=>{if(I&&I.tid){let e={content:I.content,isUser:!1};N(t=>{let s=t.filter((e,s)=>s!==t.length-1||e.isUser);return[...s,e]}),M(null)}},[I]);let{chat:{searchStatus:ej},language:{browserLanguage:eS}}=(0,f.v9)(e=>e);(0,r.useEffect)(()=>{"new_chat"===ej&&(er&&er.abort(),D([])),"dialogue"===ej&&er&&er.abort()},[ej]);let ev=(0,y.useMediaQuery)({query:"(max-width: 767px)"});return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(o.Z,{selectedTopicInfo:q,refresh:es,cStatus:ej,children:(0,a.jsxs)("div",{className:"grow px-10 overflow-y-auto scroll-smooth scrollbar-none  md:px-0 md:pt-0 ",children:["new_chat"===ej&&(0,a.jsxs)("div",{className:"absolute w-[90%] flex justify-center items-center flex-col",style:{top:0,height:"".concat(ev?"calc(100% - 4.5rem)":"100%"),left:"50%",marginLeft:"-45%"},children:[(0,a.jsxs)("div",{className:"mb-15 mt-15 text-center",children:[(0,a.jsxs)("div",{className:"h3 leading-[4rem] 2xl:mb-2 2xl:h4 flex items-center justify-center pl-4",children:["Search",(0,a.jsx)(h.default,{placement:"bottom",title:()=>(0,a.jsxs)("div",{className:"p-2",children:[(0,a.jsx)("p",{children:"Context: 4096 tokens"}),(0,a.jsx)("p",{children:"Price: $0.025 / send"})]}),children:(0,a.jsx)("div",{className:"ml-1",children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:"1.5",stroke:"currentColor",className:"w-6 h-6 text-gray-500",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"})})})})]}),(0,a.jsx)("div",{className:"body1 text-n-4 2xl:bodyS",children:el&&el.SEARCH_TITTLE[eS]})]}),el&&(0,a.jsx)(w.Z,{page:"search",json:el})]}),Array.isArray(R)&&R.length>0&&R.map((e,t)=>{let{time:s,cid:n,q:o,a:c}=e;return(0,a.jsxs)(r.Fragment,{children:[o&&(0,a.jsx)(l.Z,{content:o,time:s}),e.a&&(0,a.jsx)(i.Z,{last:t===R.length-1,message:e,chatStatus:ej})]},n+"_".concat(t))})]})}),"responding"===ej&&er&&(0,a.jsx)(v.Z,{stop:er,MODE:_}),(0,a.jsx)(n.Z,{handleSendMessage:e=>ew(e),setRefresh:e=>ea(e),refresh:es,status:ej})]})};var b=s(29492),C=s(90214),E=s(20947),k=s(7938);let T=()=>{let[e,t]=(0,r.useState)(null),[s,n]=(0,r.useState)(!0),l=(0,f.I0)();(0,E.Z)(),(0,j.Z)(()=>{l((0,S.PM)("search"))});let{userInfo:i}=(0,f.v9)(e=>e);return(0,r.useEffect)(()=>{let e=i.meData;e&&(t(e),n(!1))},[i]),(0,C.Z)(),console.log("search refresh"),(0,a.jsxs)(a.Fragment,{children:[s&&(0,a.jsx)(k.Z,{}),e&&(0,a.jsx)(u.Hf,{children:(0,a.jsx)(b.Z,{me:e,rightSidebarMode:"search",children:(0,a.jsx)(N,{})})})]})},Z=()=>(0,a.jsx)(T,{});var I=Z}},function(e){e.O(0,[277,5445,1265,5675,1664,6698,7578,1879,1929,7654,399,2588,7852,4120,9774,2888,179],function(){return e(e.s=8266)}),_N_E=e.O()}]);