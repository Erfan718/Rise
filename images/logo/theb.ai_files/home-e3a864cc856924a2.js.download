(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[229],{94309:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/home",function(){return a(27023)}])},4638:function(e,t,a){"use strict";var s=a(85893),n=a(67294),l=a(11355),o=a(18968),r=a(66180),i=a(44319);let c=e=>{let{className:t,classWrap:a,classOverlay:c,classButtonClose:d,visible:u,onClose:m,initialFocus:h,children:p,video:g,noMax:f}=e,x=e=>{e.stopPropagation()};return(0,s.jsx)(l.u,{show:u,as:n.Fragment,children:(0,s.jsxs)(o.V,{initialFocus:h,className:"fixed inset-0  z-50 flex p-6 overflow-auto scroll-smooth md:px-4 ".concat(t),onClose:m,children:[(0,s.jsx)(l.u.Child,{as:n.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:(0,s.jsx)("div",{className:"fixed inset-0 ".concat(g?"bg-n-7/95":"bg-n-7/75 dark:bg-n-6/90"," ").concat(c),"aria-hidden":"true"})}),(0,s.jsx)(l.u.Child,{as:n.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 ".concat(!g&&"scale-95"),enterTo:"opacity-100 ".concat(!g&&"scale-100"),leave:"ease-in duration-200",leaveFrom:"opacity-100 ".concat(!g&&"scale-100"),leaveTo:"opacity-0 ".concat(!g&&"scale-95"),children:(0,s.jsxs)(o.V.Panel,{className:(0,r.m)("relative z-10  w-full m-auto bg-n-1 rounded-3xl dark:bg-n-7 ".concat(g&&"static max-w-[64rem] aspect-video rounded-[1.25rem] bg-n-7 overflow-hidden shadow-[0_2.5rem_8rem_rgba(0,0,0,0.5)]"," ").concat(a),"".concat(f?"":"max-w-[65rem] !important")),onClick:x,children:[p,(0,s.jsx)("button",{className:(0,r.m)("text-0 fill-n-7 hover:fill-primary-1 ".concat(g&&"absolute top-6 right-6 w-10 h-10 bg-n-1 rounded-full"," ").concat(d)),onClick:m,children:(0,s.jsx)(i.Z,{className:"fill-inherit transition-colors",name:"close"})})]})})]})})};t.Z=c},27023:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return M}});var s=a(85893),n=a(67294),l=a(29492),o=a(68295),r=a(90214),i=a(20947),c=a(9473),d=a(7938),u=a(56726),m=a(49154),h=a(38269),p=a(43503),g=a(4638),f=a(86892),x=a(62161),y=a(84913),v=a(67556),_=a(23330),j=a(41478),b=a(4869),w=a(72206),N=a(9581),C=a(54972),S=a(39181);let k="chat",T=(0,n.lazy)(()=>a.e(7611).then(a.bind(a,27611))),Z=()=>{let[e,t]=(0,n.useState)([]),[a,l]=(0,n.useState)(null),{setIsParamsEditable:r}=(0,n.useContext)(o.py),[i,Z]=(0,n.useState)(!1),{chatHistory:F,setChatHistory:E}=(0,n.useContext)(o.py),[M,O]=(0,n.useState)(!1),{currentChat:I,setCurrentChat:A}=(0,n.useContext)(o.py),{loadingTid:H,setLoadingTid:P}=(0,n.useContext)(o.py),{setActiveChat:V,activeChat:z}=(0,n.useContext)(o.py),{currentTid:L,setCurrentTid:q}=(0,n.useContext)(o.py),{chatTitle:D,setChatTitle:$}=(0,n.useContext)(o.py),[J,U]=(0,n.useState)(!1),{isMessageSent:W,setMessageSent:B}=(0,n.useContext)(o.py),[G,R]=(0,n.useState)(null),[X,K]=(0,n.useState)([]),{selectedTopicInfo:Q,setSelectedTopicInfo:Y}=(0,n.useContext)(o.py),[ee,et]=(0,n.useState)(1),[ea,es]=(0,n.useState)(),en=(0,c.I0)(),{chat:{chatStatus:el,chatAboutInfo:eo},model:{modelData:er,chatModelParams:ei,userSelectionModel:ec},language:{browserLanguage:ed}}=(0,c.v9)(e=>e),{userInfo:{globalOrgId:eu}}=(0,c.v9)(e=>e),{tid:em,isNewTopic:eh,isTidTemp:ep,altTid:eg,titleGen:ef}=Q,ex=()=>{en((0,x.Hr)({page:k,status:"dialogue"}))};(0,f.Z)(()=>{(0,p.H7)().then(e=>{let t=e.data;if(K(t),t.length>0){if(ec){let e=t.find(e=>e.cat_id===er.cat_id&&e.model_id===er.model_id);console.log(t,"datadata"),console.log(e,"defaultModel"),e?(en((0,v.$V)(!0)),en((0,v.g)(e))):(en((0,v.$V)(!0)),en((0,v.g)(t[0])))}else en((0,v.$V)(!0)),en((0,v.g)(t[0]));en((0,v.Pm)(t))}}).catch(e=>{console.error("Failed to fetch models:",e)})});let ey=async e=>{try{let t=await(0,b.uv)(e);if(t.success){let e=t.data,a=Array.isArray(e.conversations)?e.conversations:[],s=e.topic.title;A(a),$(s);let{params:n,params_def:l}=e.topic;e.topic.params_def=(0,_.u_)(n,l),en((0,x.fb)(e))}}catch(e){}},ev=(0,n.useRef)(em);(0,n.useEffect)(()=>{if(-1!=Q.altTid&&Q.altTid==ev.current){ev.current=em;return}let e=em!=ev.current;ev.current=em,eh&&e&&Q.clearConvs&&A([]),!eh&&e&&ey(em)},[Q]),(0,n.useEffect)(()=>{U(e=>!e)},[F]),(0,n.useEffect)(()=>{if(-1!=em&&!1===ef&&!1===ep){let e=async()=>{Z(!0);try{let e=await(0,b.LK)(em);e.success&&(E(t=>{let a=t.map(t=>t.id===eg||t.id===em?{...t,title:e.data.title,id:em}:t);return a}),Y({...Q,titleGen:!0})),Z(!1)}catch(e){console.error("Error in generating title:",e),Z(!1)}};e()}},[Q]);let e_=async e=>{if("responding"==el)return!1;if(et(ee+1),r(!1),B(!0),""!==e.trim()){let t={q:e,isUser:!0,time:new Date().toISOString()};A(e=>[...e,t]);let a={a:" ",loading:!0};A(e=>[...e,a]);let s=ei.find(e=>e.cat_id===er.cat_id&&e.model_id===er.model_id),n={};s.paramsAction&&s.paramsAction.map(e=>{n[e.name]=e.default}),console.log(s,"model_params");try{(0,_.hu)(s,"model_params 没有找到默认模型或者用户所选择的模型"),en((0,x.Hr)({page:k,status:"sending"}));let t=(0,y.Z)({url:"/api/conversation?org_id=".concat(eu,"&req_rand=").concat(Math.random()),body:JSON.stringify({text:e,category:s.cat_id,model:s.model_id,model_params:n,topic_id:"dialogue"===el&&-1!=em?em:null},(e,t)=>"string"==typeof t?t.replace(/\\\\/g,"\\"):t),onOpen(e){if(console.log(el,"chatStatus"),e.success)e.success&&"new_chat"==el&&en((0,x.fb)({conversations:[],topic:{category:s.cat_id,id:"",model:s.model_id,title:"",params:{},params_def:[]}}));else{let{detail:t,errcode:a}=e.data;A(e=>{let s=e.slice(0,e.length-1),n={a:(0,_.Pq)(a,t),loading:!1};return[...s,n]}),ex()}},onMessage:async a=>{let s;let n=a.event;switch(n){case"meta":try{if((s=JSON.parse(a.data))&&s.tid){if(Q.isTidTemp&&Y({...Q,tid:s.tid,isTidTemp:!1,isNewTopic:!0,altTid:s.tid,titleGen:!1,clearConvs:!1}),"new_chat"==el){let e={id:s.tid,title:"New Chat"};E(t=>[e,...t])}q(s.tid),V(s.tid)}}catch(e){console.error("Failed to parse event data:",e);return}break;case"update":try{s=JSON.parse(a.data);let t=s.cid,n={q:e,a:s.content,time:new Date().toISOString(),cid:t};A(e=>{if(e){let t=e.slice(0,e.length-1),a=[...t,{...n,loading:!1}];return a}});let l=[...I,n];A(l),en((0,x.Hr)({page:k,status:"responding"}))}catch(e){console.error("Failed to parse event data:",e);return}break;case"err":A(e=>{let t=e.slice(0,e.length-1);return[...t,{a:"Network Anomaly",loading:!1}]}),ex(),t.abort();break;case"end":P(!0),P(!1),ex()}},onError:e=>{console.log("对话发起失败或者其他原因",e),ex(),t.abort()},onClose(){en((0,j.yA)()),et(ee+1)},onFinally(){console.log("onFinally"),ex()}});es(t)}catch(e){console.log(e,"errorerror"),ex(),ea&&ea.abort()}}};(0,n.useEffect)(()=>{if(a&&a.tid){let e={content:a.content,isUser:!1};t(t=>{let a=t.filter((e,a)=>a!==t.length-1||e.isUser);return[...a,e]}),l(null)}},[a]),(0,n.useEffect)(()=>{"new_chat"===el&&(ea&&ea.abort(),A([])),"dialogue"===el&&ea&&ea.abort()},[el]);let ej=async()=>{let e=await(0,b.p7)();console.log(e,"resresres"),e.success&&R(e.data)};(0,f.Z)(()=>{try{ej()}catch(e){}});let eb=e=>{if(e){let t=[];return Object.keys(e).map(a=>{t.push((0,s.jsx)("p",{dangerouslySetInnerHTML:{__html:"".concat(a,": ").concat(e[a])}}))}),t}};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(u.Z,{selectedTopicInfo:Q,refresh:ee,cStatus:el,children:(0,s.jsxs)("div",{className:"grow px-10 overflow-y-auto scroll-smooth scrollbar-none  md:px-0 md:pt-0 ",children:[("dialogue"===el||"responding"===el||"sending"===el)&&(0,s.jsx)("div",{className:"mb-5 mt-5 text-center",children:(0,s.jsxs)("div",{className:"btn-medium",style:{fontWeight:"600",fontSize:"1.125rem",color:"gray"},children:["Model:",(e=>{var t;let{category:a,model:s}=e;return null===(t=ei.find(e=>e.cat_id===a&&e.model_id===s))||void 0===t?void 0:t.model_name})(eo.topic)]})}),"new_chat"===el&&(0,s.jsxs)("div",{className:"absolute w-[90%] flex justify-center items-center flex-col ",style:{top:0,left:"50%",height:"100%",marginLeft:"-45%"},children:[(0,s.jsxs)("div",{className:"mb-10 text-center",children:[(0,s.jsxs)("div",{className:"h3 leading-[4rem] 2xl:mb-2 2xl:h4 flex items-center justify-center  pl-4",children:["Chat",(0,s.jsx)(S.default,{placement:"bottom",overlayClassName:"oc-300 sm:oc-none",title:()=>(0,s.jsxs)("div",{className:"p-2",children:[er.model_name,eb(null==er?void 0:er.meta)]}),children:(0,s.jsx)("div",{className:"ml-1",children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:"1.5",stroke:"currentColor",className:"w-6 h-6 text-gray-500",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"})})})})]}),(0,s.jsx)("button",{className:"btn-dark btn-medium",onClick:()=>O(!0),children:ec?er.model_name:"Select Model"}),(0,s.jsx)("div",{className:"body1 text-n-4 2xl:bodyS mt-2",children:G&&G.CHAT_TITTLE[ed]})]}),G&&(0,s.jsx)(N.Z,{page:"chat",json:G})]}),Array.isArray(I)&&I.length>0&&I.map((e,t)=>{let{time:a,cid:l,q:o,a:r}=e;return(0,s.jsxs)(n.Fragment,{children:[o&&(0,s.jsx)(m.Z,{content:o,time:a}),r&&(0,s.jsx)(h.Z,{last:t===I.length-1,message:e,chatStatus:el},l+"_".concat(t))]},l+"_".concat(t))})]})}),"responding"===el&&ea&&(0,s.jsx)(C.Z,{stop:ea,MODE:k}),(0,s.jsx)(w.Z,{handleSendMessage:e=>e_(e),setRefresh:e=>et(e),refresh:ee,status:el}),(0,s.jsx)(g.Z,{className:"md:!p-0",classWrap:"w-[86vw] md:min-h-screen-ios md:rounded-none 2xl:h-[44rem] md:h-[auto]",classButtonClose:"hidden md:block md:absolute md:top-5 md:right-5 dark:fill-n-4",classOverlay:"md:bg-n-1",visible:M,onClose:()=>O(!1),noMax:!0,children:(0,s.jsx)(n.Suspense,{fallback:(0,s.jsx)(d.Z,{}),children:(0,s.jsx)(T,{models:X,onClose:e=>{en((0,v.g)(e)),en((0,v.$V)(!0)),O(!1)}})})})]})},F=()=>{let[e,t]=(0,n.useState)(),[a,u]=(0,n.useState)(!0),m=(0,c.I0)();(0,i.Z)(),(0,f.Z)(()=>{m((0,j.PM)("chat"))});let{userInfo:h}=(0,c.v9)(e=>e);return(0,n.useEffect)(()=>{console.log(h,"userInfouserInfo");let e=h.meData;e&&(t(e),u(!1))},[h]),(0,r.Z)(),(0,s.jsxs)(s.Fragment,{children:[a&&(0,s.jsx)(d.Z,{}),e&&(0,s.jsx)(o.Hf,{children:(0,s.jsx)(l.Z,{me:e,rightSidebarMode:"chat",children:(0,s.jsx)(Z,{})})})]})},E=()=>(0,s.jsx)(F,{});var M=E}},function(e){e.O(0,[277,5445,1265,5675,1664,6698,7578,1879,1929,7654,399,2588,7852,4120,9774,2888,179],function(){return e(e.s=94309)}),_N_E=e.O()}]);